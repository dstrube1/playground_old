
IF OBJECT_ID('tempdb..#tmp') IS NOT NULL
DROP TABLE #tmp

CREATE TABLE #tmp(
	ClientId INT,
	RDate DATE
)

--INSERT INTO #tmp( ClientId,RDate)
--VALUES (3233,'06/23/2012')--(166,'6/20/2012'),(166,'6/20/2012'),(166,'6/21/2012'),(166,'6/21/2012'),(1637,'6/20/2012'),(1637,'6/20/2012'),(1637,'6/20/2012'),(1637,'6/20/2012'),(1637,'6/21/2012'),(1637,'6/21/2012'),(1637,'6/21/2012'),(1637,'6/21/2012'),(2036,'6/20/2012'),(2036,'6/20/2012'),(2036,'6/20/2012'),(2036,'6/21/2012'),(2036,'6/21/2012'),(2036,'6/21/2012'),(2036,'6/22/2012'),(2036,'6/22/2012'),(2036,'6/22/2012'),(2036,'6/23/2012'),(2036,'6/23/2012'),(2036,'6/23/2012'),(2537,'6/20/2012'),(2537,'6/20/2012'),(2537,'6/21/2012'),(2537,'6/21/2012'),(2858,'6/20/2012'),(2858,'6/21/2012'),(2858,'6/22/2012'),(2858,'6/23/2012'),(2868,'6/20/2012'),(2868,'6/21/2012'),(2868,'6/22/2012'),(2868,'6/23/2012'),(2918,'6/20/2012'),(2918,'6/20/2012'),(2918,'6/20/2012'),(2918,'6/21/2012'),(2918,'6/21/2012'),(2918,'6/21/2012'),(2918,'6/22/2012'),(2918,'6/22/2012'),(2918,'6/23/2012'),(2918,'6/23/2012'),(3000,'6/21/2012'),(3000,'6/23/2012'),(3028,'6/20/2012'),(3028,'6/21/2012'),(3028,'6/22/2012'),(3028,'6/23/2012'),(3289,'6/20/2012'),(3289,'6/20/2012'),(3289,'6/20/2012'),(3289,'6/21/2012'),(3289,'6/21/2012'),(3289,'6/21/2012'),(3489,'6/20/2012'),(3489,'6/20/2012'),(3489,'6/20/2012'),(3489,'6/21/2012'),(3489,'6/21/2012'),(3603,'6/20/2012'),(3603,'6/20/2012'),(3603,'6/20/2012'),(3603,'6/21/2012'),(3603,'6/21/2012'),(3603,'6/21/2012'),(3603,'6/22/2012'),(3603,'6/22/2012'),(3603,'6/22/2012'),(3603,'6/23/2012'),(3603,'6/23/2012'),(3603,'6/23/2012'),(3829,'6/20/2012'),(3829,'6/21/2012'),(3872,'6/20/2012'),(3872,'6/21/2012'),(3872,'6/22/2012'),(3872,'6/23/2012'),(4360,'6/20/2012'),(4801,'6/20/2012'),(4801,'6/20/2012'),(4801,'6/20/2012'),(4801,'6/21/2012'),(4801,'6/21/2012'),(4801,'6/21/2012'),(4802,'6/20/2012'),(4802,'6/20/2012'),(4802,'6/20/2012'),(4802,'6/21/2012'),(4802,'6/21/2012'),(4802,'6/21/2012'),(4802,'6/22/2012'),(4802,'6/22/2012'),(4802,'6/22/2012'),(4802,'6/23/2012'),(4802,'6/23/2012'),(4802,'6/23/2012'),(4969,'6/20/2012'),(4969,'6/20/2012'),(4969,'6/21/2012'),(4969,'6/21/2012'),(5068,'6/20/2012'),(5068,'6/21/2012'),(5068,'6/22/2012'),(5068,'6/23/2012'),(5178,'6/20/2012'),(5178,'6/21/2012'),(5178,'6/22/2012'),(5178,'6/23/2012'),(5308,'6/20/2012'),(5308,'6/20/2012'),(5308,'6/21/2012'),(5308,'6/21/2012'),(5308,'6/22/2012'),(5308,'6/22/2012'),(5308,'6/23/2012'),(5720,'6/20/2012'),(5720,'6/21/2012'),(5720,'6/22/2012'),(5720,'6/22/2012'),(5720,'6/23/2012'),(5720,'6/23/2012'),(5733,'6/20/2012'),(5733,'6/21/2012'),(5733,'6/22/2012'),(5733,'6/23/2012'),(5777,'6/20/2012'),(5777,'6/21/2012'),(5777,'6/22/2012'),(5777,'6/23/2012'),(5796,'6/20/2012'),(5796,'6/21/2012'),(5796,'6/22/2012'),(5796,'6/23/2012'),(6359,'6/20/2012'),(6359,'6/21/2012'),(6359,'6/22/2012'),(6359,'6/23/2012'),(6616,'6/20/2012'),(6727,'6/20/2012'),(6727,'6/21/2012'),(6727,'6/21/2012'),(6727,'6/22/2012'),(6727,'6/23/2012'),(6727,'6/24/2012'),(7011,'6/20/2012'),(7011,'6/21/2012'),(7011,'6/23/2012'),(7026,'6/20/2012'),(7026,'6/21/2012'),(7026,'6/22/2012'),(7026,'6/23/2012'),(7097,'6/20/2012'),(7097,'6/20/2012'),(7097,'6/20/2012'),(7097,'6/21/2012'),(7097,'6/21/2012'),(7097,'6/21/2012'),(7097,'6/22/2012'),(7097,'6/22/2012'),(7097,'6/22/2012'),(7097,'6/23/2012'),(7097,'6/23/2012'),(7097,'6/23/2012'),(7150,'6/20/2012'),(7150,'6/20/2012'),(7150,'6/21/2012'),(7150,'6/21/2012'),(7150,'6/22/2012'),(7150,'6/22/2012'),(7150,'6/23/2012'),(7150,'6/23/2012'),(7273,'6/22/2012'),(7336,'6/21/2012'),(7336,'6/21/2012')

--20-25 ALL apple


;WITH DATES AS (
	SELECT CAST ('06/20/2012' AS DATE) AS RDate
	UNION 
	SELECT CAST ('06/21/2012' AS DATE)
	UNION 
	SELECT CAST ('06/22/2012' AS DATE)
	UNION 
	SELECT CAST ('06/23/2012' AS DATE)
	UNION 
	SELECT CAST ('06/24/2012' AS DATE)
	UNION 
	SELECT CAST ('06/25/2012' AS DATE)
	
	)
INSERT INTO #tmp( ClientId,RDate)
SELECT ClientID, RDate
FROM SIProcessing..AffiliateGroupClients,DATES
WHERE AffiliateID = 100
AND StatusFlag = 1


/*
BEGIN TRAN

UPDATE cf
SET ReportProcessedDate = null 
FROM SIProcessing..CrawlingTracking_History cf
JOIN (SELECT CTHID,ROW_NUMBER() OVER (PARTITION BY cf.LastReportDate,cf.ClientID,cf.SEID ORDER BY CTHID) AS RNum
 FROM SIProcessing..CrawlingTracking_History cf
 JOIN #tmp t ON cf.LastReportDate = t.RDate
	AND cf.ClientID = t.ClientId
) tp ON tp.CTHID = cf.CTHID
	AND tp.RNum = 1

COMMIT
*/
SELECT * FROM (
SELECT cf.*, ROW_NUMBER() OVER (PARTITION BY cf.LastReportDate,cf.ClientID,cf.SEID ORDER BY CTHID) AS RNum
 FROM SIProcessing..CrawlingTracking_History cf
 JOIN #tmp t ON cf.LastReportDate = t.RDate
	AND cf.ClientID = t.ClientId
) cft
WHERE cft.RNum = 1